{% extends "_base.html" %}

{% block title %}Share {{ child.name }} | PoopyFeed{% endblock title %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <a href="{% url 'children:child_list' %}" class="text-decoration-none text-body-secondary">
          <i class="fa-solid fa-arrow-left me-1"></i>Back to Children
        </a>
        <h1 class="h3 mb-0 mt-2">
          <i class="fa-solid fa-share-nodes me-2 text-primary"></i>Share {{ child.name }}
        </h1>
      </div>
    </div>

    <!-- Current Shared Users -->
    <div class="card shadow-sm border-0 rounded-4 mb-4">
      <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
        <h2 class="h5 mb-0">
          <i class="fa-solid fa-users me-2 text-secondary"></i>People with Access
        </h2>
      </div>
      <div class="card-body px-4">
        {% if shares %}
          <div class="list-group list-group-flush">
            {% for share in shares %}
              <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                <div>
                  <span class="fw-medium">{{ share.user.email }}</span>
                  <span class="badge {% if share.role == 'CO' %}bg-primary{% else %}bg-secondary{% endif %} ms-2">
                    {{ share.get_role_display }}
                  </span>
                  <div class="text-body-secondary small">
                    Added {{ share.created_at|date:"M j, Y" }}
                  </div>
                </div>
                <form method="post" action="{% url 'children:revoke_access' child.pk share.pk %}"
                      onsubmit="return confirm('Remove access for {{ share.user.email }}?');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline-danger btn-sm">
                    <i class="fa-solid fa-user-minus me-1"></i>Remove
                  </button>
                </form>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-body-secondary mb-0">
            <i class="fa-solid fa-info-circle me-1"></i>
            No one else has access to {{ child.name }} yet. Create an invite link below.
          </p>
        {% endif %}
      </div>
    </div>

    <!-- Create Invite Link -->
    <div class="card shadow-sm border-0 rounded-4 mb-4">
      <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
        <h2 class="h5 mb-0">
          <i class="fa-solid fa-link me-2 text-secondary"></i>Create Invite Link
        </h2>
      </div>
      <div class="card-body px-4">
        <form method="post" action="{% url 'children:create_invite' child.pk %}">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label fw-medium">Access Level</label>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-check card p-3 h-100">
                  <input class="form-check-input" type="radio" name="role" id="role-coparent" value="CO">
                  <label class="form-check-label" for="role-coparent">
                    <span class="fw-semibold">Co-parent</span>
                    <p class="text-body-secondary small mb-0 mt-1">
                      Full access: can view, add, edit, and delete entries
                    </p>
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check card p-3 h-100">
                  <input class="form-check-input" type="radio" name="role" id="role-caregiver" value="CG" checked>
                  <label class="form-check-label" for="role-caregiver">
                    <span class="fw-semibold">Caregiver</span>
                    <p class="text-body-secondary small mb-0 mt-1">
                      Limited access: can view and add entries, but cannot edit or delete
                    </p>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fa-solid fa-plus me-1"></i>Create Invite Link
          </button>
        </form>
      </div>
    </div>

    <!-- Existing Invite Links -->
    <div class="card shadow-sm border-0 rounded-4">
      <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
        <h2 class="h5 mb-0">
          <i class="fa-solid fa-envelope-open-text me-2 text-secondary"></i>Active Invite Links
        </h2>
      </div>
      <div class="card-body px-4">
        {% if invites %}
          <div class="list-group list-group-flush">
            {% for invite in invites %}
              <div class="list-group-item px-0 py-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <span class="badge {% if invite.role == 'CO' %}bg-primary{% else %}bg-secondary{% endif %}">
                      {{ invite.get_role_display }}
                    </span>
                    {% if not invite.is_active %}
                      <span class="badge bg-warning text-dark ms-1">Inactive</span>
                    {% endif %}
                    <span class="text-body-secondary small ms-2">
                      Created {{ invite.created_at|date:"M j, Y" }}
                    </span>
                  </div>
                  <div class="btn-group btn-group-sm">
                    <form method="post" action="{% url 'children:toggle_invite' child.pk invite.pk %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-secondary btn-sm">
                        {% if invite.is_active %}
                          <i class="fa-solid fa-pause me-1"></i>Deactivate
                        {% else %}
                          <i class="fa-solid fa-play me-1"></i>Activate
                        {% endif %}
                      </button>
                    </form>
                    <form method="post" action="{% url 'children:delete_invite' child.pk invite.pk %}"
                          class="d-inline"
                          onsubmit="return confirm('Delete this invite link?');">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-danger btn-sm">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </form>
                  </div>
                </div>
                {% if invite.is_active %}
                  <div class="input-group input-group-sm">
                    <input type="text" class="form-control font-monospace bg-body-secondary"
                           value="{{ request.scheme }}://{{ request.get_host }}{% url 'children:accept_invite' invite.token %}"
                           readonly id="invite-{{ invite.pk }}">
                    <button class="btn btn-outline-primary" type="button"
                            onclick="copyInviteLink('invite-{{ invite.pk }}')">
                      <i class="fa-solid fa-copy"></i>
                    </button>
                  </div>
                {% else %}
                  <p class="text-body-secondary small mb-0">
                    <i class="fa-solid fa-circle-info me-1"></i>
                    This link is deactivated. Activate it to share.
                  </p>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-body-secondary mb-0">
            <i class="fa-solid fa-info-circle me-1"></i>
            No invite links created yet. Create one above to share access.
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
function copyInviteLink(inputId) {
  const input = document.getElementById(inputId);
  input.select();
  input.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(input.value).then(function() {
    // Show feedback
    const btn = input.nextElementSibling;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-check"></i>';
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-success');
    setTimeout(function() {
      btn.innerHTML = originalHtml;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-primary');
    }, 2000);
  });
}
</script>
{% endblock extra_js %}
