{% extends "_base.html" %}
{% load tz %}

{% block title %}Share {{ child.name }} | PoopyFeed{% endblock title %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8 col-lg-6">

    <!-- Header -->
    <nav aria-label="Breadcrumb" class="mb-3">
      <ol class="breadcrumb mb-0 small">
        <li class="breadcrumb-item"><a href="{% url 'children:child_list' %}" class="text-decoration-none">My Children</a></li>
        <li class="breadcrumb-item"><a href="{% url 'children:child_dashboard' pk=child.pk %}" class="text-decoration-none">{{ child.name }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">Sharing</li>
      </ol>
    </nav>

    <div class="mb-4">
      <h1 class="h3 fw-bold mb-1">
        <i class="fa-solid fa-share-nodes me-2 text-primary"></i>Share {{ child.name }}
      </h1>
      <p class="text-body-secondary small mb-0">Let others help track {{ child.name }}'s care</p>
    </div>

    <!-- Create Invite -->
    <div class="card border-0 shadow-sm rounded-4 mb-4">
      <div class="card-body p-4">
        <form method="post" action="{% url 'children:create_invite' child.pk %}">
          {% csrf_token %}

          <!-- Role Selection -->
          <div class="row g-3 mb-4">
            <div class="col-6">
              <input type="radio" class="btn-check" name="role" id="role-coparent" value="CO" autocomplete="off">
              <label class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-4 rounded-4" for="role-coparent">
                <i class="fa-solid fa-user-group fa-2x mb-2"></i>
                <span class="fw-bold">Co-parent</span>
                <small class="text-body-secondary mt-1">Full access</small>
              </label>
            </div>
            <div class="col-6">
              <input type="radio" class="btn-check" name="role" id="role-caregiver" value="CG" autocomplete="off" checked>
              <label class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-4 rounded-4" for="role-caregiver">
                <i class="fa-solid fa-hand-holding-heart fa-2x mb-2"></i>
                <span class="fw-bold">Caregiver</span>
                <small class="text-body-secondary mt-1">View & add only</small>
              </label>
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-lg w-100 py-3 rounded-3 fw-bold">
            <i class="fa-solid fa-wand-magic-sparkles me-2"></i>Create Invite Link
          </button>
        </form>
      </div>
    </div>

    {% if invites %}
    <!-- Invite Links -->
    <div class="card border-0 shadow-sm rounded-4 mb-4">
      <div class="card-header bg-transparent border-0 pt-4 pb-2 px-4">
        <div class="d-flex align-items-center justify-content-between">
          <h2 class="h6 fw-bold mb-0">
            <i class="fa-solid fa-link me-2 text-primary"></i>Invite Links
          </h2>
          <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">{{ invites|length }}</span>
        </div>
      </div>
      <div class="card-body px-4 pb-4">
        {% for invite in invites %}
        <div class="{% if not invite.is_active %}opacity-50{% endif %} {% if not forloop.last %}mb-4 pb-4 border-bottom{% endif %}">

          <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
            <span class="badge {% if invite.role == 'CO' %}bg-primary{% else %}bg-success{% endif %} bg-opacity-10 {% if invite.role == 'CO' %}text-primary{% else %}text-success{% endif %} rounded-pill px-3 py-2 small">
              <i class="fa-solid {% if invite.role == 'CO' %}fa-user-group{% else %}fa-hand-holding-heart{% endif %} me-1"></i>
              {{ invite.get_role_display }}
            </span>
            {% if not invite.is_active %}
            <span class="badge bg-warning bg-opacity-10 text-warning rounded-pill px-3 py-2 small">
              <i class="fa-solid fa-pause me-1"></i>Paused
            </span>
            {% endif %}
            <span class="text-body-tertiary small ms-auto">{% timezone user_timezone %}{{ invite.created_at|date:"M j" }}{% endtimezone %}</span>
          </div>

          {% if invite.is_active %}
          <button type="button"
                  class="btn btn-outline-primary btn-lg w-100 py-3 rounded-3 fw-bold copy-btn mb-3"
                  data-url="{{ request.scheme }}://{{ request.get_host }}{% url 'children:accept_invite' invite.token %}"
                  onclick="copyLink(this)">
            <i class="fa-solid fa-copy me-2 copy-icon"></i>
            <i class="fa-solid fa-check me-2 check-icon d-none"></i>
            <span class="btn-text">Tap to Copy Link</span>
          </button>
          {% endif %}

          <div class="d-flex gap-2">
            <form method="post" action="{% url 'children:toggle_invite' child.pk invite.pk %}" class="flex-fill">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-secondary w-100 py-2 small">
                {% if invite.is_active %}
                <i class="fa-solid fa-pause me-1"></i>Pause
                {% else %}
                <i class="fa-solid fa-play me-1"></i>Resume
                {% endif %}
              </button>
            </form>
            <form method="post" action="{% url 'children:delete_invite' child.pk invite.pk %}" class="flex-fill"
                  onsubmit="return confirm('Delete this invite link?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger w-100 py-2 small">
                <i class="fa-solid fa-trash me-1"></i>Delete
              </button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if shares %}
    <!-- People with Access -->
    <div class="card border-0 shadow-sm rounded-4 mb-4">
      <div class="card-header bg-transparent border-0 pt-4 pb-2 px-4">
        <div class="d-flex align-items-center justify-content-between">
          <h2 class="h6 fw-bold mb-0">
            <i class="fa-solid fa-users me-2 text-primary"></i>People with Access
          </h2>
          <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">{{ shares|length }}</span>
        </div>
      </div>
      <div class="card-body px-4 pb-4">
        {% for share in shares %}
        <div class="d-flex align-items-center gap-3 {% if not forloop.last %}mb-3 pb-3 border-bottom{% endif %}">
          <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px;">
            <i class="fa-solid fa-user"></i>
          </div>
          <div class="flex-grow-1 min-width-0">
            <div class="fw-semibold small text-truncate">{{ share.user.email }}</div>
            <div class="d-flex align-items-center gap-2 mt-1">
              <span class="badge {% if share.role == 'CO' %}bg-primary{% else %}bg-success{% endif %} bg-opacity-10 {% if share.role == 'CO' %}text-primary{% else %}text-success{% endif %} rounded-pill small">
                {{ share.get_role_display }}
              </span>
              <span class="text-body-tertiary small">{% timezone user_timezone %}{{ share.created_at|date:"M j" }}{% endtimezone %}</span>
            </div>
          </div>
          <form method="post" action="{% url 'children:revoke_access' child.pk share.pk %}"
                onsubmit="return confirm('Remove access for {{ share.user.email }}?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-sm rounded-3 px-3" title="Remove access">
              <i class="fa-solid fa-user-minus"></i>
            </button>
          </form>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if not invites and not shares %}
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body text-center py-5">
        <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 56px; height: 56px;">
          <i class="fa-solid fa-paper-plane fa-lg text-primary"></i>
        </div>
        <p class="text-body-secondary small mb-0">
          Create an invite link above and share it with<br>
          your co-parent, nanny, or family member
        </p>
      </div>
    </div>
    {% endif %}

  </div>
</div>

<!-- Toast -->
<div class="toast-container position-fixed bottom-0 start-50 translate-middle-x p-3">
  <div id="copyToast" class="toast align-items-center text-bg-success border-0 rounded-pill" role="alert">
    <div class="d-flex">
      <div class="toast-body fw-bold">
        <i class="fa-solid fa-check-circle me-2"></i>Link copied!
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
function copyLink(btn) {
  var url = btn.dataset.url;

  navigator.clipboard.writeText(url).then(function() {
    showCopySuccess(btn);
  }).catch(function() {
    var input = document.createElement('input');
    input.value = url;
    document.body.appendChild(input);
    input.select();
    document.execCommand('copy');
    document.body.removeChild(input);
    showCopySuccess(btn);
  });
}

function showCopySuccess(btn) {
  btn.classList.remove('btn-outline-primary');
  btn.classList.add('btn-success');
  btn.querySelector('.copy-icon').classList.add('d-none');
  btn.querySelector('.check-icon').classList.remove('d-none');
  btn.querySelector('.btn-text').textContent = 'Copied!';

  var toast = new bootstrap.Toast(document.getElementById('copyToast'), {
    delay: 2000
  });
  toast.show();

  setTimeout(function() {
    btn.classList.remove('btn-success');
    btn.classList.add('btn-outline-primary');
    btn.querySelector('.copy-icon').classList.remove('d-none');
    btn.querySelector('.check-icon').classList.add('d-none');
    btn.querySelector('.btn-text').textContent = 'Tap to Copy Link';
  }, 2500);
}
</script>
{% endblock extra_js %}
